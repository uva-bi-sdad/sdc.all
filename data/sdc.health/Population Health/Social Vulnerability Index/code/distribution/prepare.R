library(tidyverse)

# svi_2020_county <- read.csv("https://svi.cdc.gov/Documents/Data/2020_SVI_Data/CSV/States_Counties/Virginia_COUNTY.csv")
# svi_2020_tract <- read.csv("https://svi.cdc.gov/Documents/Data/2020_SVI_Data/CSV/States/Virginia.csv")
# 
# svi_2018_county <- read.csv("https://svi.cdc.gov/Documents/Data/2018_SVI_Data/CSV/States_Counties/Virginia_COUNTY.csv")
# svi_2018_tract <- read.csv("https://svi.cdc.gov/Documents/Data/2018_SVI_Data/CSV/States/Virginia.csv")
# 
# svi_2016_county <- read.csv("https://svi.cdc.gov/Documents/Data/2016_SVI_Data/CSV/States_Counties/Virginia_COUNTY.csv")
# svi_2016_tract <- read.csv("https://svi.cdc.gov/Documents/Data/2016_SVI_Data/CSV/States/Virginia.csv")
# 
# svi_2014_county <- read.csv("https://svi.cdc.gov/Documents/Data/2014_SVI_Data/CSV/States_Counties/Virginia_CNTY.csv")
# svi_2014_tract <- read.csv("https://svi.cdc.gov/Documents/Data/2014_SVI_Data/CSV/States/Virginia.csv")

yrs <- c(2020, 2018, 2016, 2014)
urls.county <- c(paste0("https://svi.cdc.gov/Documents/Data/", c(2020, 2018, 2016), "_SVI_Data/CSV/States_Counties/Virginia_COUNTY.csv"), "https://svi.cdc.gov/Documents/Data/2014_SVI_Data/CSV/States_Counties/Virginia_CNTY.csv")
urls.tract <- paste0("https://svi.cdc.gov/Documents/Data/", yrs, "_SVI_Data/CSV/States/Virginia.csv")

va_cttr_2014_2020_social_vulnerability_index <- data.frame()
for(i in 1:length(yrs)){
  df.county <- read.csv(urls.county[i]) %>% select(geoid = FIPS,
                                                    county = COUNTY,
                                                    vi_socioeconomic = RPL_THEME1,
                                                    vi_household = RPL_THEME2,
                                                    vi_race_ethnicity = RPL_THEME3,
                                                    vi_housing_transportation = RPL_THEME4,
                                                    vi_overall = RPL_THEMES) %>% mutate(year = yrs[i])
  df.county.long <- pivot_longer(df.county,
                                 cols = c("vi_socioeconomic", "vi_household", "vi_race_ethnicity", "vi_housing_transportation", "vi_overall"), 
                                 names_to = "measure", values_to = "value")
  df.tract <- read.csv(urls.tract[i]) %>% select(geoid = FIPS,
                                                  county = COUNTY,
                                                  vi_socioeconomic = RPL_THEME1,
                                                  vi_household = RPL_THEME2,
                                                  vi_race_ethnicity = RPL_THEME3,
                                                  vi_housing_transportation = RPL_THEME4,
                                                  vi_overall = RPL_THEMES) %>% mutate(year = yrs[i])
  df.tract.long <- pivot_longer(df.tract,
                                 cols = c("vi_socioeconomic", "vi_household", "vi_race_ethnicity", "vi_housing_transportation", "vi_overall"), 
                                 names_to = "measure", values_to = "value")
  
  va_cttr_2014_2020_social_vulnerability_index <- rbind(va_cttr_2014_2020_social_vulnerability_index, df.county.long, df.tract.long)
}

va_cttr_2014_2020_social_vulnerability_index <- va_cttr_2014_2020_social_vulnerability_index %>% mutate(measure_type = "float", value = na_if(value, -999)) %>% select(-county)

write_csv(va_cttr_2014_2020_social_vulnerability_index, xzfile("./va_cttr_2014_2020_social_vulnerability_index.csv.xz", compression = 9))










