!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DataHandler=t()}(this,(function(){"use strict";var e=function(){return e=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};function t(e,t,a,n){return new(a||(a=Promise))((function(i,r){function s(e){try{m(n.next(e))}catch(e){r(e)}}function o(e){try{m(n.throw(e))}catch(e){r(e)}}function m(e){e.done?i(e.value):function(e){return e instanceof a?e:new a((function(t){t(e)}))}(e.value).then(s,o)}m((n=n.apply(e,t||[])).next())}))}function a(e,t){var a,n,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function o(o){return function(m){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;r&&(r=0,o[0]&&(s=0)),s;)try{if(a=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{a=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,m])}}}var n={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},i={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},r={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}},s={file_format:function(e){return-1===i.file_format.indexOf(e)},table_format:function(e){return-1===i.table_format.indexOf(e)},include:function(e,t){for(var a=e.length;a--;)if(!(e[a]in t))return e[a];return""}},o={"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)}};function m(e,t){if(Array.isArray(e)){for(var a=Math.min(t[1]+1,e.length),n={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[a-1]},i=0,r=Math.max(t[0],0);r<a;r++){var s=e[r];"number"==typeof s?isNaN(s)?n.missing++:(i++,n.min>s&&(n.min=s),n.max<s&&(n.max=s),n.sum+=s):"NA"!==s&&i++}return n.mean=i?n.sum/i:0,n}return{missing:Number(isNaN(e))+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}var u={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g};var l=Object.freeze({__proto__:null,mixed:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s=[],o=this.meta.times[e.group].value,m="";Object.keys(a).forEach((function(t){m+='"'+e.features[a[t]]+'"'+i}));for(var u=t[1]+1,l=function(t){var a=m+o[t];n.forEach((function(n){var s=e.variables[n].code;if(s in e.data){var o=r.meta.variables[e.group][n].time_range,m=e.data[s],u=NaN;Array.isArray(m)?t>=o[0]&&t<=o[1]&&(u=m[t-o[0]]):t===o[0]&&(u=m),a+=i+(isNaN(u)?"NA":u)}else a+=i+"NA"})),s.push(a)},f=t[0];f<u;f++)l(f);return s.join("\n")}return""},tall:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s=[],o=this.meta.times[e.group].value,m="";return Object.keys(a).forEach((function(t){m+='"'+e.features[a[t]]+'"'+i})),n.forEach((function(a){var n=e.variables[a].code;if(n in e.data){for(var u=r.meta.variables[e.group][a].time_range,l="",f=t[1]+1,d=t[0];d<f;d++)if(d>=u[0]&&d<=u[1]){var c=e.data[n],h=Array.isArray(c)?c[d-u[0]]:c;isNaN(h)||(l+=(l?"\n":"")+m+o[d]+i+'"'+a+'"'+i+h)}l&&s.push(l)}})),s.join("\n")}return""},wide:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s="";return Object.keys(a).forEach((function(t){s+=(s?i:"")+'"'+e.features[a[t]]+'"'})),n.forEach((function(a){for(var n=e.variables[a].code,o=r.meta.ranges[a],m=r.meta.variables[e.group][a].time_range,u=t[1]+1,l=t[0];l<u;l++)if(l>=o[0]&&l<=o[1])if(n in e.data){var f=e.data[n],d=NaN;Array.isArray(f)?l>=m[0]&&l<=m[1]&&(d=f[l-m[0]]):l===m[0]&&(d=f),s+=i+(isNaN(d)?"NA":d)}else s+=i+"NA"})),s}return""}});function f(e,o,f,d){return t(this,void 0,void 0,(function(){var t,c,h,_,v,p,g,b,y,w,k,N,O,x,E,j,A,q,S,T=this;return a(this,(function(a){switch(a.label){case 0:return f?[3,2]:[4,this.data_ready];case 1:a.sent(),a.label=2;case 2:for(x in t=this.parse_query(e),o=o||this.entities,-1===i.file_format.indexOf(t.file_format)&&(t.file_format=n.file_format),t.table_format in l||(t.table_format=n.table_format),c={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Disposition":"attachment; filename="},body:"Invalid Request"},h=t.include&&t.include.length?"string"==typeof t.include?t.include.split(","):t.include:Object.keys(this.variables),_=t.exclude||[],v=[],p=t.features||JSON.parse(JSON.stringify(n.features)),g=[],b=[1/0,-1/0],y="csv"===t.file_format?",":"\t",w=l[t.table_format].bind(this),k=!t.variables.filter_by.length,N=!t.feature_conditions.length,O="dataset"in t?r[t.dataset.operator].bind(t.dataset.value):function(){return!0},h.forEach((function(e){e in T.features&&!(e in p)&&(p[e]=T.format_label(e))})),s)if(x in t&&(E=s[x]("include"===x?h:t[x],this.variables)))return c.body="Failed check for "+x+": "+E,[2,c];return Object.keys(this.variable_codes).forEach((function(e){if(-1!==h.indexOf(T.variable_codes[e].name)&&-1===_.indexOf(T.variable_codes[e].name)){v.push(T.variable_codes[e].name);var t=T.meta.ranges[T.variable_codes[e].name];t[0]<b[0]&&(b[0]=t[0]),t[1]>b[1]&&(b[1]=t[1])}})),t.time_range[0]<b[0]&&(t.time_range[0]=b[0]),t.time_range[1]>b[1]&&(t.time_range[1]=b[1]),g.push(Object.keys(p).join(y)),"wide"===t.table_format?v.forEach((function(e){for(var a=T.meta.ranges[e],n=Math.min(t.time_range[1],a[1])+1,i=Math.max(t.time_range[0],a[0]);i<n;i++)g[0]+=y+e+"_"+T.meta.overall.value[i]})):g[0]+=y+"time"+y+("mixed"===t.table_format?v:["variable","value"]).join(y),j="",Object.keys(o).forEach((function(e){var a=o[e];if(O(a.group)&&(N||function(e,t,a){for(var n=e[t],i=function(t){var i=a[t].value;if("-1"!==i){if("id"===a[t].name&&Array.isArray(i)){var r=!1;return i.forEach((function(t){if(!r){var a=t in e&&e[t].group;(a&&a in n.features?t===n.features[a]:t.length<n.features.id.length?t===n.features.id.substring(0,t.length):t===n.features.id)&&(r=!0)}})),{value:r}}if(!a[t].check(n.features[a[t].name]))return{value:!1}}},r=a.length;r--;){var s=i(r);if("object"==typeof s)return s.value}return!0}(o,e,t.feature_conditions))&&(k||function(e,t,a,n){for(var i={},r={},s=a.filter_by.length;s--;){var o=a.filter_by[s],u=n[o].code;if(!(u in e.data))return!1;var l=e.group in n[o].info?n[o].info[e.group].time_range:n[o].time_range[e.group];if(!l)return!1;r[o]=l[0],i[o]=m(e.data[u],[t[0]-l[0],Math.max(t[1]-l[0],t[1]-l[1])])}for(s=a.conditions.length;s--;){var f=a.conditions[s];if(!(f.time_component?f.check(e.data[n[f.name].code],r[f.name]||0):f.check(i[f.name])))return!1}return!0}(a,t.time_range,t.variables,T.variables))){var n=w(a,t.time_range,p,v,y);n&&(j||(j=e),g.push(n))}})),c.headers["Content-Type"]="text/"+(","===y?"csv":"plain")+"; charset=utf-8",c.body=g.join("\n"),A=this.meta.overall.value,q="export_"+(f&&!d&&j?o[j].group+"_":t.dataset?t.dataset.value+"_":"")+(t.time_range[0]===t.time_range[1]?A[t.time_range[0]]:A[t.time_range[0]]+"-"+A[t.time_range[1]])+"_"+(1===v.length?this.variables[v[0]].meta.short_name.toLowerCase().replace(u.non_letter_num,"-"):v.length+"-variables")+"_"+(g.join("\n").split("\n").length-1)+"x"+g[0].split(y).length,f&&(S=document.createElement("a"),document.body.appendChild(S),S.rel="noreferrer",S.target="_blank",S.download=q+"."+t.file_format,S.href=URL.createObjectURL(new Blob([c.body],{type:c.headers["Content-Type"]})),setTimeout((function(){S.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,S.href),document.body.removeChild(S)}),0)),c.statusCode=200,c.headers["Content-Disposition"]+=q+"."+t.file_format,[2,c]}}))}))}var d=Object.freeze({__proto__:null,multi:function(e,t){if(t<0)return NaN;if(this.variables[e].is_time)return Array.isArray(this.time.value)?this.time.value[t]:this.time.value;e=this.variables[e].code;var a=this.data[e];return e in this.data?Array.isArray(a)?t<a.length?a[t]:NaN:0===t?a:NaN:NaN},row_time:function(e,t,a){var n=this.i-(a.offset-this.o);return e&&n>=0&&n<e.length?"number"==typeof e[n]?this.format_value(e[n],a.int):e[n]:NaN},single:function(e,t){return t<0?NaN:this.variables[e].is_time?Array.isArray(this.time.value)&&t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)}});function c(e,t){return null===e||isNaN(e)?NaN:t||"string"==typeof this.settings.settings.digits?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)}function h(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(u.seps," ").replace(u.word_start,(function(e){return e.toUpperCase()}))}function _(e,t){var a=this;if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={name:t,site_file:t+".json",schema:{fields:[]},ids:[]}),"_meta"in e){var n=e._meta.time;this.meta.times[t]=n,"number"==typeof n.value&&(n.value=[n.value]);var i=n.value;n.n=i.length,n.is_single=1===n.n,n.range=[i[0],i[n.n-1]],e._meta.time.name in this.variables&&(n.info=this.variables[n.name],n.info.is_time=!0),n.range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=n.range[0]),n.range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=n.range[1]),i.forEach((function(e){-1===a.meta.overall.value.indexOf(e)&&a.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((function(e){e in a.variables||(a.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",name:e,code:e,views:{},meta:{full_name:e,measure:e.split(":")[1]||e,short_name:a.format_label(e),long_name:e,type:"unknown"}},a.variable_info[e]=a.variables[e].meta),a.variables[e].name=e,a.variables[e].code=a.meta.variables[t][e].code;var n=a.meta.variables[t][e].time_range;a.variables[e].time_range[t]=n,a.variable_codes[a.variables[e].code]=a.variables[e],-1!==n[0]&&(e in a.meta.ranges?(n[0]<a.meta.ranges[e][0]&&(a.meta.ranges[e][0]=n[0]),n[1]>a.meta.ranges[e][1]&&(a.meta.ranges[e][1]=n[1])):a.meta.ranges[e]=[n[0],n[1]])}))}this.load_id_maps()}function v(){return t(this,void 0,void 0,(function(){var e=this;return a(this,(function(t){return this.metadata.datasets&&this.metadata.datasets.forEach((function(t){var a=!1;t in e.info&&e.info[t].ids.forEach((function(n,i){if("map"in n){a=!0;var r=n.map;if(r in e.data_maps)if(e.data_maps[r].retrieved){var s=t in e.data_maps[r].resource?e.data_maps[r].resource[t]:e.data_maps[r].resource;e.info[t].schema.fields[i].ids=e.entity_features[t]=s,e.map_entities(t)}else{var o=e.data_maps[r].queue;-1===o.indexOf(t)&&o.push(t)}else if("string"!=typeof r||n.map_content){if("string"==typeof r){e.data_maps[r]={queue:[],resource:JSON.parse(n.map_content),retrieved:!0};s=t in e.data_maps[r].resource?e.data_maps[r].resource[t]:e.data_maps[r].resource;e.info[t].schema.fields[i].ids=e.entity_features[t]=s}else e.entity_features[t]=r;e.map_entities(t)}else if(e.data_maps[r]={queue:[t],resource:{},retrieved:!1},e.settings.entity_info&&r in e.settings.entity_info){var m=e.settings.entity_info;"string"==typeof m[r]&&(m[r]=JSON.parse(m[r])),e.ingest_map(m[r],r,i)}else if("undefined"==typeof window)require("https").get(r,(function(t){var a=[];t.on("data",(function(e){a.push(e)})),t.on("end",(function(){e.ingest_map(JSON.parse(a.join("")),t.req.protocol+"//"+t.req.host+t.req.path,i)}))})).end();else{var u=new window.XMLHttpRequest;u.onreadystatechange=function(e,t){if(4===u.readyState){if(200!==u.status)throw new Error("data_handler.ingester.id_maps failed: "+u.responseText);this.ingest_map(JSON.parse(u.responseText),e,t)}}.bind(e,r,i),u.open("GET",r,!0),u.send()}}})),a||(e.entity_features[t]={},e.map_entities(t))})),[2]}))}))}function p(e,t,a){var n=this;this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((function(e){if(n.info[e].schema.fields.length>a){e in n.entity_features||(n.entity_features[e]={});var i=e in n.data_maps[t].resource?n.data_maps[t].resource[e]:n.data_maps[t].resource;n.info[e].schema.fields[a].ids=n.entity_features[e]=i,n.map_entities(e)}})),this.hooks.data_load&&this.hooks.data_load()}function g(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}function b(e,t){var a=this;this.inited_summary[t+e]||this.settings.view_names.forEach((function(n){var i=a.variables[e];n in i.views||(i.views[n]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{},table:{}}),t in i.time_range||(i.time_range[t]=[0,a.meta.times[t].n-1]);var r=i.time_range[t][2]=i.time_range[t][1]-i.time_range[t][0]+1,s=i.views[n],o=i.code;if(t in a.sets){var m=a.sets[t],u=a.info[t].entity_count,l=!u||u>65535?Uint32Array:u>255?Uint16Array:Uint8Array,f=i.info[t],d="string"===f.type,c=f.order;if(c)Object.keys(m).forEach((function(t){t in a.entities&&(n in a.entities[t].views||(a.entities[t].views[n]={summary:{},rank:{},subset_rank:{}}),a.entities[t].views[n].rank[e]=new l(r),a.entities[t].views[n].subset_rank[e]=new l(r))}));else{f.order=c=[];for(var h=r;h--;)c.push([]);Object.keys(m).forEach((function(t){var s=m[t];if("_meta"!==t&&o in s){var u=s[o];if(Array.isArray(u)){for(var f=r;f--;)d&&u[f]in i.level_ids?u[f]=i.level_ids[u[f]]:"number"!=typeof u[f]&&(u[f]=NaN),c[f].push([t,u[f]]);Object.freeze(u)}else d&&u in i.level_ids?c[0].push([t,i.level_ids[u]]):"number"!=typeof u?(s[o]=NaN,c[0].push([t,NaN])):c[0].push([t,u]);if(!(t in a.entities))return;n in a.entities[t].views||(a.entities[t].views[n]={summary:{},rank:{},subset_rank:{}});var h=a.entities[t].views[n];e in h.rank||(h.rank[e]=new l(r),h.subset_rank[e]=new l(r))}}))}c.forEach((function(t,i){Object.isFrozen(t)||(t.sort(g),Object.freeze(t)),t.forEach((function(t,r){a.entities[t[0]].views[n].rank[e][i]=r}))}))}if(!(t in s.summaries)){s.order[t]=[],s.selected_order[t]=[],s.selected_summaries[t]={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};var _={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};if("string"===i.info[t].type){_.type="string",_.level_ids=i.level_ids,_.levels=i.levels,s.table={},i.levels.forEach((function(e){s.table[e]=[];for(var t=r;t--;)s.table[e].push(0)}));for(h=r;h--;)s.order[t].push([]),s.selected_order[t].push([]),_.missing.push(0),_.n.push(0),_.mode.push("");s.summaries[t]=_}else{for(h=r;h--;)s.order[t].push([]),s.selected_order[t].push([]),s.selected_summaries[t].n.push(0),s.selected_summaries[t].missing.push(0),_.missing.push(0),_.n.push(0),_.sum.push(0),_.max.push(-1/0),_.q3.push(0),_.mean.push(0),_.norm_median.push(0),_.break_median.push(-1),_.lower_median_min.push(-1),_.lower_median_range.push(-1),_.upper_median_min.push(-1),_.upper_median_range.push(-1),_.norm_mean.push(0),_.break_mean.push(-1),_.lower_mean_min.push(-1),_.lower_mean_range.push(-1),_.upper_mean_min.push(-1),_.upper_mean_range.push(-1),_.median.push(0),_.q1.push(0),_.min.push(1/0);s.summaries[t]=_}Object.seal(s.order[t]),Object.seal(s.selected_order[t]),Object.seal(s.selected_summaries[t]),Object.seal(s.summaries[t])}}))}function y(e,t,a,n){var i=e*(t-1),r=i%1,s=1-r,o=a+Math.ceil(i);return n[a+Math.floor(i)][1]*r+n[o][1]*s}function w(e,n,i){return t(this,void 0,void 0,(function(){var t,r,s,o,m,u,l,f,d,c,h,_,v,p,g,b,w,k,N,O,x=this;return a(this,(function(a){switch(a.label){case 0:return t=this.settings.dataviews[n],r=t.get.dataset(),[4,this.data_processed[r]];case 1:if(a.sent(),s=r+e,this.inited_summary[s]||this.init_summary(e,r),this.inited_summary[s]=new Promise((function(e){x.summary_ready[s]=e})),o=this.variables[e],(m=o.views[n]).state[r]===t.state)return[3,2];for(u=t.selection[this.settings.settings.summary_selection],l=t.selection.all,f=m.order[r],d=m.selected_order[r],c=o.time_range[r][2],h=o.info[r].order,_=o.levels,v=o.level_ids,p=t.n_selected[this.settings.settings.summary_selection]!==t.n_selected.dataset,g=m.selected_summaries[r],b=m.summaries[r],w="string"===o.type,k=function(e){f[e]=p?[]:h[e],d[e]=p?[]:h[e],g.missing[e]=0,g.n[e]=0,b.missing[e]=0,b.n[e]=0,w?(b.mode[e]="",_.forEach((function(t){return m.table[t][e]=0}))):(b.sum[e]=0,b.mean[e]=0,b.max[e]=-1/0,b.min[e]=1/0,b.break_mean[e]=-1,b.break_median[e]=-1)},O=c;O--;)k(O);if(h.forEach((function(t,a){var r=f[a],s=d[a],o=0;t.forEach((function(t){var d=t[0],c=t[1];if(d in u){var h=u[d].views[n],v=!isNaN(c);a||(e in h.summary||(h.summary[e]={n:0,overall:b,order:f}),h.summary[e].n=0),i&&p&&(r.push(t),d in l&&(s.push(t),v?g.n[a]++:g.missing[a]++)),v?(h.subset_rank[e][a]=o++,h.summary[e].n++,b.n[a]++,w?m.table[_[c]][a]++:(b.sum[a]+=c,c>b.max[a]&&(b.max[a]=c),c<b.min[a]&&(b.min[a]=c))):b.missing[a]++}}))})),i)f.forEach((function(e,t){if(w)if(b.n[t]){var a=0;Object.keys(m.table).forEach((function(e){m.table[e][t]>m.table[_[a]][t]&&(a=v[e])})),b.mode[t]=_[a]}else b.mode[t]="";else{if(b.n[t]){b.mean[t]=b.sum[t]/b.n[t],isFinite(b.min[t])||(b.min[t]=b.mean[t]),isFinite(b.max[t])||(b.max[t]=b.mean[t]),b.range[t]=b.max[t]-b.min[t],1===b.n[t]?b.q3[t]=b.median[t]=b.q1[t]=null==e[0][1]?b.mean[t]:e[0][1]:(b.median[t]=y(.5,b.n[t],b.missing[t],e),b.q3[t]=y(.75,b.n[t],b.missing[t],e),b.q1[t]=y(.25,b.n[t],b.missing[t],e));for(var n=e.length,i=b.missing[t],r=!1,s=!1;i<n;i++){var o=e[i][1];if("number"==typeof o&&(!r&&o>b.median[t]&&(b.break_median[t]=i-1,r=!0),!s&&o>b.mean[t]&&(b.break_mean[t]=i-1,s=!0)),r&&s)break}}else b.max[t]=0,b.q3[t]=0,b.median[t]=0,b.q1[t]=0,b.min[t]=0;b.n[t]&&(b.norm_median[t]=b.range[t]?(b.median[t]-b.min[t])/b.range[t]:.5,-1!==b.break_median[t]&&(b.lower_median_min[t]=b.norm_median[t]-(e[b.missing[t]][1]-b.min[t])/b.range[t],b.lower_median_range[t]=b.norm_median[t]-((e[b.break_median[t]][1]-b.min[t])/b.range[t]-b.lower_median_min[t]),b.upper_median_min[t]=b.norm_median[t]-(e[b.break_median[t]][1]-b.min[t])/b.range[t],b.upper_median_range[t]=(e[e.length-1][1]-b.min[t])/b.range[t]-b.norm_median[t]-b.upper_median_min[t]),b.norm_mean[t]=b.range[t]?(b.mean[t]-b.min[t])/b.range[t]:.5,-1!==b.break_mean[t]&&(b.lower_mean_min[t]=b.norm_mean[t]-(e[b.missing[t]][1]-b.min[t])/b.range[t],b.lower_mean_range[t]=b.norm_mean[t]-((e[b.break_mean[t]][1]-b.min[t])/b.range[t]-b.lower_mean_min[t]),b.upper_mean_min[t]=b.norm_mean[t]-(e[b.break_mean[t]][1]-b.min[t])/b.range[t],b.upper_mean_range[t]=(e[e.length-1][1]-b.min[t])/b.range[t]-b.norm_mean[t]-b.upper_mean_min[t]))}}));else for(N=function(e){if(b.n[e])if(w){var t=0;Object.keys(m.table).forEach((function(a){m.table[a][e]>m.table[_[t]][e]&&(t=v[a])})),b.mode[e]=_[t]}else b.mean[e]=b.sum[e]/b.n[e];else b[w?"mode":"mean"][e]=NaN},O=0;O<c;O++)N(O);return b.filled=!0,m.state[r]=t.state,this.summary_ready[s](),[3,4];case 2:return[4,this.summary_ready[s]];case 3:a.sent(),a.label=4;case 4:return[2]}}))}))}function k(){var e=this;this.metadata.datasets.forEach((function(t){e.data_queue[t]={};var a=e.info[t];a&&(a.id_vars=a.ids.map((function(e){return e.variable})),a.schema.fields.forEach((function(a){var n=a.name;if(n in e.variables){var i=e.variables[n];i.datasets.push(t),i.info[t]=a,"string"===a.type&&(i.levels=[],i.level_ids={},(a.info&&a.info.levels||Object.keys(a.table)).forEach((function(e){e in i.level_ids||(i.level_ids[e]=i.levels.length,i.levels.push(e))})))}else{var r=e.variables[n]={datasets:[t],info:{},time_range:{},type:a.type,code:n,name:n,meta:a.info,levels:[],level_ids:{},table:{},order:[],views:{}};r.info[t]=a,"string"===a.type&&(r.levels=[],r.level_ids={},Object.keys(a.table).forEach((function(e){r.level_ids[e]=r.levels.length,r.levels.push(e)}))),r.meta||(r.meta={full_name:n,measure:n.split(":")[1]||n,short_name:e.format_label(n),type:a.type||"unknown"}),r.meta.full_name=n,"measure"in r.meta||(r.meta.measure=n.split(":")[1]||n),"short_name"in r.meta||(r.meta.short_name=e.format_label(n)),"long_name"in r.meta||(r.meta.long_name=r.meta.short_name),n in e.variable_info||(e.variable_info[n]=r.meta)}})))}))}function N(e){return t(this,void 0,void 0,(function(){var t,n,i,r,s,o,m=this;return a(this,(function(a){for(o in e in this.sets&&!this.inited[e]&&e in this.meta.times&&(t=this.sets[e],n=this.meta.times[e],i=A.retrievers[n.is_single?"single":"multi"],r=Object.keys(this.sets),s=this.info,Object.keys(t).forEach((function(a){var o=t[a],u=a.length;if("_meta"!==a){var l=m.entity_features[e][a],f=l||{id:a,name:a};f.id=a,f.name||(f.name=a);var d=a in m.entities?m.entities[a]:{group:e,data:o,variables:m.variables,features:f,views:{}};a in m.entities?(d.group=e,d.data=o,d.variables=m.variables,d.features||(d.features={}),d.views||(d.views={})):m.entities[a]=d,a in m.entity_tree||(m.entity_tree[a]={parents:{},children:{}});var c=m.entity_tree[a];d.relations=c,Object.keys(f).forEach((function(e){e in m.features||(m.features[e]=m.format_label(e)),"id"!==e&&!l&&e in d.features||(d.features[e]=f[e]),-1!==m.metadata.datasets.indexOf(e)&&(f[e]in m.entity_tree||(m.entity_tree[f[e]]={parents:{},children:{}}),m.entity_tree[f[e]].children[a]=c,c.parents[f[e]]=m.entity_tree[f[e]])})),s&&r.forEach((function(e){var t=e in s&&s[e].id_length;if(t&&t<u){var n=a.substring(0,t);n in m.sets[e]&&(n in m.entity_tree||(m.entity_tree[n]={parents:{},children:{}}),m.entity_tree[n].children[a]=c,c.parents[n]=m.entity_tree[n])}})),m.settings.view_names.forEach((function(e){e in d.views||(d.views[e]={summary:{},rank:{},subset_rank:{}})})),d.time=n,d.get_value=i.bind(d)}})),this.inited[e]=!0,this.data_promise[e](),setTimeout((function(){m.inited.first||(m.hooks.init&&m.hooks.init(),m.inited.first=!0),e in m.data_queue&&Object.keys(m.data_queue[e]).forEach((function(t){m.data_queue[e][t](),delete m.data_queue[e][t]})),m.hooks.onload&&m.hooks.onload(e)}),0)),this.info)if(Object.prototype.hasOwnProperty.call(this.info,o)&&!this.inited[o])return[2,void 0];return this.all_data_ready(),[2]}))}))}var O={any:/\{(?:categor|variant)/,category:/\{categor(?:y|ies)(\.[^}]+?)?\}/g,variant:/\{variants?(\.[^}]+?)?\}/g,all:/\{(?:categor(?:y|ies)|variants?)(\.[^}]+?)?\}/g,desc:/description$/};function x(e,t,a,n,i){void 0===i&&(i="default"),t.lastIndex=0;for(var r=void 0,s=void 0;r=t.exec(e);){var o=n&&"v"===r[0].substring(1,2)?n:a;(s=r[1]?r[1].substring(1):i)in o||("description"in o&&O.desc.test(s)?s=i="description":s===i&&(s="default"));var m=o[s];if("string"==typeof m){for(;e.includes(r[0]);)e=e.replace(r[0],m);t.lastIndex=0}}return e}function E(e,t,a,n){var i={name:"blank"===e?"":e};return Object.keys(t).forEach((function(e){var r=t[e];i[e]="string"==typeof r?x(r,n,a):r})),"default"in i||(i.default=i.name),i}function j(e){var t=this,a=JSON.parse(JSON.stringify(n));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));var s=e.split("&");e={},s.forEach((function(t){var a=t.split("=");e[a[0]]=a.length>1?a[1]:""}))}return e&&Object.keys(e).forEach((function(n){if("include"===n||"exclude"===n||n in a)a[n]=e[n];else{var s=[];u.single_operator.test(n)&&(s=n.replace(u.single_operator,"$1=$2").split("=")).length>1&&(n=s[0],e[n]=s[1]);var o=u.component.exec(n),m={name:n.replace(u.greater,">").replace(u.less,"<"),component:"mean",operator:"=",value:u.number.test(e[n])?Number(e[n]):e[n],time_component:!1,check:function(){return!1}};if("object"==typeof e[n]&&("component"in e[n]&&(m.component=e[n].component),"operator"in e[n]&&(m.operator=e[n].operator),"value"in e[n]&&(m.value=e[n].value)),n=m.name,o)if(-1!==i.filter_components.indexOf(o[2]))m.component=o[2],m.name=o[1];else if(u.number.test(o[2])){var l=Number(o[2]);-1!==(f=l>0&&l<t.meta.overall.value.length?l:t.meta.overall.value.indexOf(l))&&(m.time_component=!0,m.component=f,m.name=o[1])}if(u.operator_start.test(n)&&n[n.length-1]in A.checks&&(m.operator=n[n.length-1],s.length||(m.operator+="="),n===m.name&&(m.name=n.substring(0,n.length-1))),void 0===m.value||"-1"==m.value)return;if("="!==m.operator&&"!"!==m.operator||"string"!=typeof m.value||!u.comma.test(m.value)||(m.value=m.value.split(","),m.operator="="===m.operator?"includes":"excludes"),"time_range"===m.name){if(Array.isArray(m.value))a.time_range=[t.meta.overall.value.indexOf(Number(m.value[0])),t.meta.overall.value.indexOf(Number(m.value[1]))];else{var f=t.meta.overall.value.indexOf(Number(m.value));a.time_range="="===m.operator?[f,f]:">"===m.operator?[f,t.meta.overall.value.length-1]:[0,f]}-1===a.time_range[0]&&(a.time_range[0]=0),-1===a.time_range[1]&&(a.time_range[1]=t.meta.overall.value.length?t.meta.overall.value.length-1:0)}else"dataset"===m.name?a.dataset=m:m.name in t.features?("id"!==m.name||m.value||(m.value=String(m.value).split(",")),m.check=r[m.operator].bind(m.value),a.feature_conditions.push(m)):m.name in t.variables&&(m.check=(m.time_component?function(e,t){var a="number"!=typeof e,n="number"==typeof this.condition.component?this.condition.component-t:0;return a?this.check(e[n],this.condition.value):!n&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:A.checks[m.operator],condition:m}),-1===a.variables.filter_by.indexOf(m.name)&&a.variables.filter_by.push(m.name),a.variables.conditions.push(m))}})),"time_range"in a||(a.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),a}var A=function(){function n(n,i,r,s){var o=this;this.hooks={},this.defaults={dataview:"default_view",time:"time"},this.settings={},this.metadata={datasets:[]},this.info={},this.sets={},this.dynamic_load=!1,this.all_data_ready=function(){return!1},this.data_ready=new Promise((function(e){o.all_data_ready=e})),this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.entity_features={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.retrieve=function(e,n){return t(this,void 0,void 0,(function(){var t,i=this;return a(this,(function(a){return this.load_requests[e]||(this.load_requests[e]=n,(t=new window.XMLHttpRequest).onreadystatechange=function(){if(4===t.readyState){if(200!==t.status)throw new Error("DataHandler.retrieve failed: "+t.responseText);i.ingest_data(JSON.parse(t.responseText),e)}},t.open("GET",n,!0),t.send()),[2]}))}))},this.format_value=c,this.format_label=h,this.ingest_data=_,this.ingest_map=p,this.load_id_maps=v,this.init_summary=b,this.calculate_summary=w,this.map_variables=k,this.map_entities=N,this.parse_query=j,this.export=f,this.get_variable=function(e,n){return t(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return e in this.variables?[4,this.calculate_summary(e,n,!0)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2,this.variables[e]]}}))}))},this.get_value=function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;var t=this.variables[e.variable].code;return t in e.entity.data?Array.isArray(e.entity.data[t])?e.entity.data[t]:[e.entity.data[t]]:[NaN]},s&&(this.hooks=s),i&&(this.defaults=i),n&&(this.settings=n),this.settings.metadata&&(this.metadata=this.settings.metadata),r&&(this.sets=r),this.get_value=this.get_value.bind(this),this.dynamic_load="dataviews"in this.settings&&this.settings.settings&&!!this.settings.settings.partial_init,this.settings.view_names=this.dynamic_load?Object.keys(this.settings.dataviews):["default_view"],"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);var m=function(){if(o.metadata.datasets&&o.metadata.datasets.length||(o.metadata.datasets=Object.keys(o.info),o.metadata.datasets.length||(o.metadata.datasets=Object.keys(o.sets))),o.metadata.measure_info){var t=(a=o.metadata.measure_info,Object.keys(a).forEach((function(t){if(O.any.test(t)){var n=a[t],i=Object.keys(n);if(n.categories||n.variants){var r=Array.isArray(n.categories)?{}:n.categories||{},s=Array.isArray(n.variants)?{}:n.variants||{},o=Array.isArray(n.categories)?n.categories:Object.keys(r);o.length||o.push("");var m=Array.isArray(n.variants)?n.variants:Object.keys(s);m.length||m.push(""),o.forEach((function(o){m.forEach((function(m){var u=E(o,r[o]||{},s[m]||{},O.variant),l=E(m,s[m]||{},r[o]||{},O.category),f=e(e({},u),l),d={};i.forEach((function(e){if("categories"!==e&&"variants"!==e){var t=n[e];d[e]="string"==typeof t?x(t,O.all,u,l,e):t}})),Object.keys(f).forEach((function(e){e in d||"default"===e||"name"===e||"description"===e&&(d.long_description||d.short_description)||(d[e]=f[e])})),a[x(t,O.all,u,l)]=d}))}))}}})),a);o.metadata.datasets.forEach((function(e){t._references&&(o.info[e]._references=t._references),o.info[e].schema.fields.forEach((function(e){return e.name in t?e.info=t[e.name]:""}))}))}var a;o.map_variables(),o.metadata.datasets.forEach((function(e){o.loaded[e]=e in o.sets,o.inited[e]=!1,o.data_processed[e]=new Promise((function(t){o.data_promise[e]=t})),e in o.info&&(o.info[e].site_file=(o.metadata.url?o.metadata.url+"/":"")+o.info[e].name+".json"),o.loaded[e]?o.ingest_data(o.sets[e],e):o.dynamic_load&&(!o.settings.settings||o.settings.settings.partial_init)&&o.defaults.dataset&&e!==o.defaults.dataset||o.retrieve(e,o.info[e].site_file)}))};if(this.metadata.package&&!this.metadata.info)if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(function(e){var t=[];e.on("data",(function(e){t.push(e)})),e.on("end",(function(){o.info={};var e=JSON.parse(t.join(""));e.measure_info&&(o.metadata.measure_info=e.measure_info),e.resources.forEach((function(e){return o.info[e.name]=e})),m()}))})).end();else{var u=new window.XMLHttpRequest;u.onreadystatechange=function(){if(4===u.readyState){if(200!==u.status)throw new Error("failed to load datapackage: "+u.responseText);o.info={};var e=JSON.parse(u.responseText);e.measure_info&&(o.metadata.measure_info=e.measure_info),e.resources.forEach((function(e){return o.info[e.name]=e})),m()}},u.open("GET",this.metadata.url+this.metadata.package),u.send()}else this.metadata.info&&(this.info=this.metadata.info),m()}return n.retrievers=d,n.checks=o,n}();return A}));
//# sourceMappingURL=data_handler.v1.min.js.map
